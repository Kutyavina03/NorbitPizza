@page
@model NorbitPizza.Pages.IndexModel
@{
    ViewData["Title"] = "Норбит Пицца";
}
@section Scripts {
    <script src="~/js/index.js"></script>
}
@section Styles {
    <link rel="stylesheet" href="~/css/index.css" />
}
<div class="container">
    <h1>Норбит Пицца</h1>

    <div class="create-pizza">
        <h2>Создать свою пиццу</h2>
        <form id="createPizzaForm" onsubmit="return createPizza(event)">
            <input type="text" id="newPizzaName" placeholder="Название пиццы" required>

            <div class="ingredients">
                <h4>Ингредиенты:</h4>
                @foreach (var ingredient in Model.AvailableIngredients)
                {
                    <label>
                        <input type="checkbox" value="@ingredient">
                        @ingredient
                    </label>
                }
            </div>

            <button type="submit" onclick="alert(`Мы получили и вскоре рассмотрим ваш рецепт`)">Создать пиццу</button>
        </form>
    </div>

    <div class="filters">
        @foreach (var category in Model.Categories)
        {
            <a href="#" class="filter-btn" data-category="@category">@category</a>
        }
    </div>

    <div class="pizzas" id="pizzasContainer">
        @foreach (var pizza in Model.Pizzas)
        {
            <div class="pizza-card" data-category="@pizza.Category">
                <img src="@pizza.ImageUrl" alt="@pizza.Name" onerror="this.src='/images/pizza-placeholder.jpg'">
                <h3>@pizza.Name</h3>
                <p class="info">@pizza.Description</p>
                <p class="price">@pizza.Price руб.</p>
                <p class="ingredients">@string.Join(", ", pizza.Ingredients)</p>
                <button onclick="addToCart(@pizza.Id, '@pizza.Name', @pizza.Price, @pizza.IsCustom.ToString().ToLower())">
                    В корзину
                </button>
            </div>
        }
    </div>
</div>

<div id="cart">
    <h3>Корзина</h3>
    <div id="cart-items"></div>
    <div id="total">Итого: 0 руб.</div>
    <a asp-page="/Cart" class="go-to-cart-btn">Перейти в корзину</a>
</div>

<script>
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    updateCart();
    let pizzas = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Pizzas));

    function addToCart(id, name, price, isCustom) {
    const existing = cart.find(item => item.id === id && item.isCustom === isCustom);

    if (existing) {
        existing.quantity++;
    } else {
        cart.push({ id, name, price, quantity: 1, isCustom });
    }


    localStorage.setItem('cart', JSON.stringify(cart));
    updateCart();
    }


    function updateCart() {
         const items = document.getElementById('cart-items');
    const total = document.getElementById('total');

    items.innerHTML = '';
    let sum = 0;

    cart.forEach((item, index) => {
        sum += item.price * item.quantity;

    const div = document.createElement('div');
    div.className = 'cart-item';


    div.innerHTML = `${item.name} — ${item.price} руб. × `;


    const minus = document.createElement('button');
    minus.textContent = '−';
        minus.onclick = () => {
            if (item.quantity > 1) {
        item.quantity--;
            } else {
        cart.splice(index, 1);
            }
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCart();
        };
    div.appendChild(minus);


    const qty = document.createElement('span');
    qty.textContent = ` ${item.quantity} `;
    div.appendChild(qty);


    const plus = document.createElement('button');
    plus.textContent = '+';
        plus.onclick = () => {
        item.quantity++;
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCart();
        };
    div.appendChild(plus);


    const removeBtn = document.createElement('button');
    removeBtn.textContent = '×';
        removeBtn.onclick = () => {
        cart.splice(index, 1);
    localStorage.setItem('cart', JSON.stringify(cart));
    updateCart();
        };
    div.appendChild(removeBtn);

    items.appendChild(div);
    });

    total.textContent = `Итого: ${sum} руб.`;
    }

    function removeFromCart(index) {
        cart.splice(index, 1);
    updateCart();
    }

    function createPizza(event) {
        event.preventDefault();
    const name = document.getElementById('newPizzaName').value;
        const selected = [...document.querySelectorAll('.create-pizza input[type=checkbox]:checked')].map(i => i.value);
    if (!name) return alert('Введите название пиццы!');

    const pizza = {
        id: Date.now(),
    name: name,
    price: 500,
    ingredients: selected,
    isCustom: true,
    imageUrl: '/images/pizza-placeholder.jpg',
    description: 'Ваша собственная пицца',
    Category: 'Custom'
        };

    pizzas.push(pizza);
    renderPizzas();
    document.getElementById('createPizzaForm').reset();
    return false;
    }

    function renderPizzas() {
        const container = document.getElementById('pizzasContainer');
    container.innerHTML = '';

        pizzas.forEach(pizza => {
            const card = document.createElement('div');
    card.className = 'pizza-card';
    card.dataset.category = pizza.Category;

    card.innerHTML = `
    <img src="${pizza.imageUrl}" alt="${pizza.name}" onerror="this.src='/images/pizza-placeholder.jpg'">
        <h3>${pizza.name}</h3>
        <p>${pizza.description}</p>
        <p class="price">${pizza.price} руб.</p>
        <p class="ingredients">${pizza.ingredients.join(', ')}</p>
        `;

        const btn = document.createElement('button');
        btn.textContent = 'В корзину';
            btn.onclick = () => addToCart(pizza.id, pizza.name, pizza.price, pizza.isCustom);
        card.appendChild(btn);

        container.appendChild(card);
        });
    }

    document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const category = btn.dataset.category;
                document.querySelectorAll('.pizza-card').forEach(card => {
                    if (category === 'All' || card.dataset.category === category) {
                        card.style.display = 'block';
                    } else {
                        card.style.display = 'none';
                    }
                });
            });
    });

</script>

